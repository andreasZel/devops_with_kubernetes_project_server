<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>The project</title>
</head>

<body>
    <h1>MOOC.fi DevOps with Kubernetes</h1>
    <img id="apiImage" src="image/cachedImage.png" alt="API Image" />
    <form id="todoForm" onsubmit="createTodo">
        <span><input type="text" maxlength="140" name="todoText" /></span>
        <span><button>Create todo</button></span>
    </form>
    <h2>Todos</h2>
    <ul id="todoListUL">
        <li>Learn Docker</li>
        <li>Learn Kubernetes</li>
    </ul>
    <h2>Done</h2>
    <ul id="todoDoneListUL"></ul>
    <script>
        function getTodos() {
            const todoField = document.getElementById('todoListUL');
            todoField.innerHTML = '';

            fetch('/todos').then(async (resp) => {
                const respJSON = await resp.json();

                for (let todoID in respJSON) {
                    const li = document.createElement('li');
                    li.innerText = respJSON[todoID];
                    const doneBtn = document.createElement('button');
                    doneBtn.innerText = 'Mark as Done';
                    doneBtn.addEventListener('click', () => {
                        setDoneTodos(todo.id);
                    })
                    li.append(doneBtn);
                    todoField.appendChild(li);
                }
            }).catch((e) => {
                console.log(e);
            })
        }

        function getDoneTodos() {
            const todoField = document.getElementById('todoDoneListUL');
            todoField.innerHTML = '';

            fetch('/todos/done').then(async (resp) => {
                const respJSON = await resp.json();

                for (let todoID in respJSON) {
                    const li = document.createElement('li');
                    li.innerText = respJSON[todoID];

                    todoField.appendChild(li);
                }
            }).catch((e) => {
                console.log(e);
            })
        }

        function setDoneTodos(id) {
            const todoField = document.getElementById('todoDoneListUL');
            todoField.innerHTML = '';

            fetch(`/todos/done/${id}`, { method: 'POST' }).then(() => {
                getTodos();
                getDoneTodos();
            }).catch((e) => {
                console.log(e);
            })
        }

        getTodos();
        getDoneTodos();

        fetch('/getImage')
            .then(() => {
                const img = document.getElementById('apiImage');
                img.src = 'image/cachedImage.png?t=' + Date.now();
            })
            .catch(err => console.error('Image update failed', err));

        const form = document.getElementById('todoForm');

        form.addEventListener('submit', function (event) {
            event.preventDefault();

            const formData = new FormData(form);
            const todo = formData.get('todoText');

            fetch('/todos', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ newTodo: todo })
            }).then(() => {
                getTodos();
            }).catch((e) => {
                console.log(e);
            })

            form.reset();
        });
    </script>
</body>

</html>