<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>The project</title>
</head>

<body>
    <h1>MOOC.fi DevOps with Kubernetes</h1>
    <img id="apiImage" src="image/cachedImage.png" alt="API Image" />
    <form id="todoForm" onsubmit="createTodo">
        <span><input type="text" maxlength="140" name="todoText" /></span>
        <span><button>Create todo</button></span>
    </form>
    <ul id="todoListUL">
        <li>Learn Docker</li>
        <li>Learn Kubernetes</li>
    </ul>
    <script>
        function getTodos() {
            const todoField = document.getElementById('todoListUL');
            todoField.innerHTML = '';

            fetch('/todos').then(async (resp) => {
                const respJSON = await resp.json();
                
                for (let todoID in respJSON) {
                    const li = document.createElement('li');
                    li.innerText = respJSON[todoID];

                    todoField.appendChild(li);
                }
            }).catch((e) => {
                console.log(e);
            })
        }

        getTodos();

        fetch('/getImage')
            .then(() => {
                const img = document.getElementById('apiImage');
                img.src = 'image/cachedImage.png?t=' + Date.now();
            })
            .catch(err => console.error('Image update failed', err));

        const form = document.getElementById('todoForm');

        form.addEventListener('submit', function (event) {
            event.preventDefault();

            const formData = new FormData(form);
            const todo = formData.get('todoText');

            fetch('/todos', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ newTodo: todo })
            }).then(() => {
                getTodos();
            }).catch((e) => {
                console.log(e);
            })

            form.reset();
        });
    </script>
</body>

</html>